# ORA システム更新履歴 (Changelog)

このファイルは、ORAシステムの進化を日単位で記録し、追加機能や修正内容を正確に把握するためのものです。

## 2026-01-05 (安定化と高性能モデルの復旧)

本日は、Discordのレート制限回避、メモリ最適化ロジックの刷新、および最強モデル「Shared Traffic（共有トラフィック）」シリーズの完全復旧とバグ修正を行いました。

### ✨ 追加機能・改善 (Features & Enhancements)

*   **3段階の「ユーザー最適化」戦略の確立**
    *   **即時（Real-time）**: 5メッセージ蓄積ごとに自動で最適化（API不使用）。
    *   **自動（Background）**: 1時間ごとにオンラインユーザーを検索。ローカルログのみを使用し、API消費ゼロ。
    *   **手動（Manual）**: `/optimize_user` 指令により、Discord APIを用いた深掘りスキャンを実行（安全なインターバル設定付き）。
*   **仕様の永続化（マニフェスト作成）**
    *   `ORA_OPTIMIZATION_MANIFEST.md`: 最適化ロジックの固定。
    *   `ORA_MODEL_MANIFEST.md`: 本日の最強モデルリスト（Shared Traffic）の定義。
*   **「忘れるな」警告ヘッダーの埋め込み**
    *   `src/cogs/memory.py` および `src/cogs/ora.py` の先頭に、将来的なデグレードを防ぐための警告文を追加。

### 🔧 致命的なバグの修正 (Critical Bug Fixes)

*   **Shared Traffic モデルの404エラー修復**
    *   `gpt-5.1-codex` が「Chatモデルではない」として拒否される問題を解決。
    *   `llm_client.py` を改造し、Codex系モデルの場合は自動的に `v1/completions` (Legacy Endpoint) に切り替えて通信するロジックを実装。
*   **モデルパラメータの安全性確保**
    *   `gpt-5`系、`o1`系、`codex`系でエラーの原因となる `temperature` パラメータを自動的に削除するフィルタを実装。
*   **LLMフォールバック時のクラッシュ修正**
    *   OpenAIがエラーの際にローカルLLMに切り替わる過程で発生していた `tuple object has no attribute strip` エラー（アンパック漏れ）を修正。

### ⚙️ 設定変更 (Configuration)

*   **高性能モデルの完全復帰**
    *   `src/config.py` のルーター設定を、貴方様の環境で無料利用可能な `gpt-5.1-codex`, `gpt-5.1`, `gpt-5-mini` 等に再設定。
*   **コンソールノイズの低減**
    *   `discord.http` および `discord.gateway` のログレベルを `WARNING` に設定し、レート制限警告などの不要なスパムを抑制。
*   **【緊急修正】最適化ハングアップ（Processing停止）の解決**
    *   `memory.py` 内に古い関数定義（`_analyze_batch`）が重複して存在していたため、最新の修正（ログ出力など）が適用されていなかったバグを修正。
    *   不要な重複コード（約200行）を削除。これにより、送信ログ `Sending...` が正しく表示されるようになります。

2026 01 05 今日やったこと要約

デバッグ基盤の強化
Debugチャンネル 1455097004433604860 へログをリアルタイム転送する仕組みを実装
logger を QueueHandler 対応にして ログ転送の安定性と詰まりにくさを改善
system.py に LogForwarder タスクを追加して 起動時に自動で回るように整理

Healer 2 0 と自己進化の入口づくり
Healer をボタン式にして Apply Dismiss で提案を適用 破棄できるように実装
ボタン操作を管理者ID 1069941291661672498 のみに制限して 誤操作と乗っ取りを防止
dev_request と request_feature を追加して 既存機能で無理な依頼が来たときに 機能追加の提案フローへ繋ぐ土台を作成
判断プロトコルを導入して できるなら既存ツール実行 できないなら進化リクエストへ という分岐を明文化

通知ノイズ対策 と 日本語化
重要通知のみ流すようにフィルタを強化して INFO スパムを抑制
AutoScan の No history found など不要通知をブロック 対象ログのレベルも見直し
Debug通知のタイトルや主要文言を日本語化して 状況が追いやすい表示に変更

メモリ学習 ダッシュボード関連の不具合対応
学習ログが消えて見えていた原因を特定して Memory 系通知が正しく見えるように許可リストを調整
Worker Bot が存在するだけでメインが処理を遠慮して止まるバグを修正 オフラインならメインが処理するように変更
リアルタイム学習を 5メッセージ到達で即トリガーするように修正
勝手な過去ログ大量取得を止めて Discord API レート制限問題を抑制
手動 optimize_user は必要時のみ API を使って深掘りできるよう復旧
バックグラウンドの徐々に深掘りは 低速 429バックオフ付きで復活

自律進化の安全装置 ガードレール実装
backup_manager を追加して 適用前に全体スナップショットをZIPで保存
health_inspector を追加して 適用後に診断を自動実行
診断NGなら自動ロールバックして 失敗レポートを出す流れを Healer 適用処理に統合

セキュリティ 情報漏えい防止
Confidentiality Protocol を入れて 非管理者には ファイルツリー 設定 コード等の内部情報を出さない方針を組み込み
管理者向け詳細は Debugチャンネルへ必ず残す ログの監査性を強化

運用系のバグ修正
discord 429 Rate limit 系のうるさいログを抑制
LogForwarder の msg 未定義エラーを修正
healer.py の Healer クラス欠損による ImportError を修復

ドキュメント化 変更履歴の固定
現在の最適化ルールを ORA_OPTIMIZATION_MANIFEST md に明文化
今後の改変時に必ず参照させる警告ヘッダを memory.py と ora.py に追加
日付で追える変更履歴として ORA_CHANGELOG md を作成し 2026 01 05 の変更点を記録できる形に整備

## 2026-01-07 (最新モデル対応とダッシュボード復旧)

本日は、ユーザー様からのご指摘に基づき、GPT-5系モデルのAPI仕様への完全対応と、それによるダッシュボード更新不全の解消を行いました。

### 🚀 モデル知識とAPI刷新 (Model Knowledge & API Upgrade)

*   **Next-Gen Agentic Endpoint (`/responses`) への対応**
    *   **仕様変更**: `gpt-5.*`, `o1`, `o4`, `codex` などの次世代モデルが従来の `/chat/completions` ではなく、Agentic Endpoint `/responses` を使用するように `src/utils/llm_client.py` を修正しました。
    *   **Temperature パラメータの撤廃**: Reasoningモデルにおいて `temperature` 指定が禁止されているため、対象モデルでは自動的にリクエストから除外するロジックを実装しました。
    *   **トークンパラメータの自動変換**: `max_tokens` を `max_output_tokens` (Agentic API仕様) に自動変換するように修正しました。

*   **標準モデル・コーディングモデルの再定義**
    *   **Standard**: `gpt-5-mini`, `gpt-4.1-mini` を標準モデルとして定義・検証しました。
    *   **Coding**: `gpt-5.1-codex` をコーディング用モデルとして `config.py` および `healer.py` に固定しました。
    *   **Strict Limits**: ユーザー指定の厳格なモデルグループ分けとトークンリミット（25万 / 250万）を `src/config.py` にテキストとして埋め込み、動作設定にも反映しました。

### 🐛 バグ修正とシステム復旧 (Bug Fixes & System Recovery)

*   **ダッシュボード更新不全の解消**
    *   **原因**: `/responses` APIが返すJSON形式（`output` キー）に `llm_client.py` が対応しておらず、解析エラーで保存処理が中断されていました。
    *   **修正**: `output` キーを正しくテキストとして読み込むパーサーを追加し、正常にプロフィール保存が行われるように修正しました。
    *   **スタック解除トリガー**: `refresh_profiles.trigger` を実装し、次回起動時に「更新が止まっていたユーザー」を自動検出し、分析キューに再投入する仕組みを構築しました。

*   **デバッグ・検証**
    *   `scripts/debug_llm_client.py` を作成し、実際のAPIペイロード生成ロジック（Temperature除外、エンドポイント切り替え）が意図通りに動作することを証明しました。

これにより、現在利用可能な最新・最強のモデル群を用いて、エラーなく安全にシステムが稼働する状態となりました。

## 2026-01-09 (音楽機能の完成とUI刷新)

本日は、ユーザー体験を損なっていた音楽再生機能の不具合を根絶し、操作性・視認性を大幅に向上させました。また、管理者機能の利便性強化を行いました。

### 🎵 音楽機能の完全修正 (Music Dashboard Overhaul)

*   **再生位置の維持（シームレスな倍速変更）**
    *   倍速（Speed/Pitch）ボタンを押した際に、曲が最初から再生される問題を修正。
    *   現在の再生時間を計算し、再エンコード時に `-ss` (seek) オプションを付与することで、リスニング体験を途切れさせないようにしました。
*   **AI再生コマンドの統合**
    *   「VCで流して」とチャットで依頼した際も、`/play` コマンド同様の**リッチな操作パネル（ダッシュボード）**を表示するように変更。
    *   **テキスト応答の抑制**: ダッシュボード表示時には「再生を開始します」という冗長なAIチャット応答を自動で削除し、画面をスッキリさせました。
*   **不具合修正**
    *   `MediaCog` 内のインデントミスにより、AI経由の再生メソッドが見つからなかった致命的なバグを修正。
    *   プログレスバーの秒数が更新されない問題を解決。

### 🛡️ 管理・セキュリティ機能 (Admin & Security)

*   **チャットによるオーバーライド実装**
    *   スラッシュコマンド (`/system_override`) に加え、「**管理者権限でオーバーライド**」とチャットするだけでシステム制限解除（Unlimited Mode）が発動するようにトリガーを追加。
*   **ガードレールの堅牢化**
    *   セキュリティチェック（Guardrail）が返すJSONを文字列として誤処理していたバグを修正（`AttributeError` 解消）。

### 🎨 UI/UXの刷新 (Modernization)

*   **実行ログのカード化**
    *   思考ログ（StatusManager）を、長大なテキストリストから**Embed（カード形式）**に変更。
    *   アニメーション絵文字と色付き枠を採用し、視認性を大幅に向上。

これにより、音楽ボットとしての完成度が飛躍的に向上し、管理者としての操作もスムーズになりました。

## 2026-01-11 (究極の自己進化と安全装置の実装)

本日は、「自らコードを書き換える」という危険な行為を、**鉄壁の安全性**のもとで実行可能にするための大規模アップデートを行いました。また、AIが「ルール遵守」や「適用範囲」を自ら判断するロジックを実装しました。

### 🛡️ 自己進化システムの完全刷新 (Ultimate Self-Evolution)

*   **監視役ボット「Guardian」の実装**
    *   `src/watcher.py`: 自己進化プロセス中だけ起動する別プロセスの監視役を作成。
    *   **生存信号（Heartbeat）**: メインBotが `data/heartbeat.json` に書き込む生存信号（エラーログ付き）を常時監視。
    *   **クラッシュループ検知**: 「起動はするがすぐ死ぬ」状態を検出し、自動でバックアップを復元。
    *   **緊急連絡網**: Discord APIすら応答しない緊急事態に備え、Webhook経由での通知ルートを確保。

*   **自己治癒（Self-Healing）ループ**
    *   `src/utils/healer.py` の更新ロジックを刷新。
    *   **構文チェック（Pre-Flight）**: 適用前に `py_compile` で構文エラーを検知。
    *   **自動修正**: エラーが出た場合、即座に諦めず、LLMにエラーログを投げて修正コードを再生成させるリトライループ（最大3回）を実装。

*   **アトミックバックアップ**
    *   更新対象ファイルだけでなく、`src/` フォルダ全体をZIPで固める完全スナップショット方式に変更。

### 🧠 AI判断ロジックの高度化 (Advanced Decision Logic)

*   **リスク・コンプライアンス判定**
    *   ユーザーのリクエストが「サーバールール」や「Discord利用規約」に違反しないかを文脈から判断。
    *   違反/危険と判断された場合は自動適用を拒否し、管理者に理由付きで提案通知を送ります。

*   **Global / Local スコープ自動判別**
    *   「このサーバーだけで使いたい」という要望を理解し、コード生成時に `if ctx.guild.id != ...` というガード条件を自動挿入。
    *   特定のサーバー専用機能を、他のサーバーに影響を与えずに安全に追加可能にしました。

*   **透明性の高い通知**
    *   提案時に `Risk` (危険度), `Compliance` (ルール遵守), `Scope` (適用範囲) の判定結果を明示し、管理者が承認判断しやすいフォーマットに変更しました。
